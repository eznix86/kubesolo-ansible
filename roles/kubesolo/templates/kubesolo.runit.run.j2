#!/bin/sh
# KubeSolo runit run script
# Generated by Ansible
# Place this file at /etc/sv/kubesolo/run

exec 2>&1

# Set ulimits
ulimit -n 65535

# Set environment variables
{% if kubesolo_proxy %}
export HTTP_PROXY="{{ kubesolo_proxy }}"
export HTTPS_PROXY="{{ kubesolo_proxy }}"
export NO_PROXY="localhost,127.0.0.1,0.0.0.0,10.0.0.0/8,192.168.0.0/16"
{% endif %}

# Build command arguments
CMD_ARGS="--path={{ kubesolo_path }}"
{% if kubesolo_apiserver_extra_sans | length > 0 %}
CMD_ARGS="$CMD_ARGS --apiserver-extra-sans={{ kubesolo_apiserver_extra_sans | join(',') }}"
{% endif %}
{% if kubesolo_portainer_edge_id %}
CMD_ARGS="$CMD_ARGS --portainer-edge-id={{ kubesolo_portainer_edge_id }}"
{% endif %}
{% if kubesolo_portainer_edge_key %}
CMD_ARGS="$CMD_ARGS --portainer-edge-key={{ kubesolo_portainer_edge_key }}"
{% endif %}
{% if kubesolo_portainer_edge_async %}
CMD_ARGS="$CMD_ARGS --portainer-edge-async"
{% endif %}
{% if kubesolo_local_storage %}
CMD_ARGS="$CMD_ARGS --local-storage"
{% endif %}
{% if kubesolo_debug %}
CMD_ARGS="$CMD_ARGS --debug"
{% endif %}
{% if kubesolo_pprof_server %}
CMD_ARGS="$CMD_ARGS --pprof-server"
{% endif %}

# Use chpst to run with proper resource limits
exec chpst -P \
  {{ kubesolo_install_path }} $CMD_ARGS
