#!/bin/sh
# KubeSolo control script for minimal mode
# Generated by Ansible
# This script provides start/stop/status/logs/kubeconfig management for KubeSolo

KUBESOLO_BIN="{{ kubesolo_install_path }}"
KUBESOLO_PATH="{{ kubesolo_path }}"
PIDFILE="{{ kubesolo_pidfile }}"
LOGFILE="{{ kubesolo_logfile }}"
KUBECONFIG_PATH="{{ kubesolo_path }}/pki/admin/admin.kubeconfig"

# Build command arguments
CMD_ARGS="--path=$KUBESOLO_PATH"
{% if kubesolo_apiserver_extra_sans | length > 0 %}
CMD_ARGS="$CMD_ARGS --apiserver-extra-sans={{ kubesolo_apiserver_extra_sans | join(',') }}"
{% endif %}
{% if kubesolo_portainer_edge_id %}
CMD_ARGS="$CMD_ARGS --portainer-edge-id={{ kubesolo_portainer_edge_id }}"
{% endif %}
{% if kubesolo_portainer_edge_key %}
CMD_ARGS="$CMD_ARGS --portainer-edge-key={{ kubesolo_portainer_edge_key }}"
{% endif %}
{% if kubesolo_portainer_edge_async %}
CMD_ARGS="$CMD_ARGS --portainer-edge-async={{ kubesolo_portainer_edge_async }}"
{% endif %}
{% if kubesolo_local_storage %}
CMD_ARGS="$CMD_ARGS --local-storage=true"
{% endif %}
{% if kubesolo_debug %}
CMD_ARGS="$CMD_ARGS --debug=true"
{% endif %}
{% if kubesolo_pprof_server %}
CMD_ARGS="$CMD_ARGS --pprof-server=true"
{% endif %}

{% if kubesolo_proxy %}
export HTTP_PROXY="{{ kubesolo_proxy }}"
export HTTPS_PROXY="{{ kubesolo_proxy }}"
export NO_PROXY="localhost,127.0.0.1,0.0.0.0,10.0.0.0/8,192.168.0.0/16"
{% endif %}

# Helper functions
is_running() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID" 2>/dev/null; then
            return 0
        else
            rm -f "$PIDFILE"
            return 1
        fi
    fi
    return 1
}

do_start() {
    if is_running; then
        echo "KubeSolo is already running (PID: $(cat $PIDFILE))"
        return 0
    fi

    echo "Starting KubeSolo..."
    mkdir -p "$(dirname $PIDFILE)" "$(dirname $LOGFILE)"

    # Start in background
    nohup $KUBESOLO_BIN $CMD_ARGS >> "$LOGFILE" 2>&1 &
    echo $! > "$PIDFILE"

    # Wait a moment and check if it's running
    sleep 2
    if is_running; then
        echo "KubeSolo started successfully (PID: $(cat $PIDFILE))"
        return 0
    else
        echo "Failed to start KubeSolo. Check logs at: $LOGFILE"
        return 1
    fi
}

do_stop() {
    if ! is_running; then
        echo "KubeSolo is not running"
        return 0
    fi

    PID=$(cat "$PIDFILE")
    echo "Stopping KubeSolo (PID: $PID)..."

    # Try graceful shutdown
    kill -TERM "$PID" 2>/dev/null

    # Wait for process to stop
    for i in $(seq 1 30); do
        if ! kill -0 "$PID" 2>/dev/null; then
            rm -f "$PIDFILE"
            echo "KubeSolo stopped"
            return 0
        fi
        sleep 1
    done

    # Force kill if still running
    echo "Forcing KubeSolo to stop..."
    kill -KILL "$PID" 2>/dev/null
    rm -f "$PIDFILE"
    echo "KubeSolo stopped (forced)"
    return 0
}

do_status() {
    if is_running; then
        PID=$(cat "$PIDFILE")
        echo "KubeSolo is running (PID: $PID)"
        return 0
    else
        echo "KubeSolo is not running"
        return 1
    fi
}

do_logs() {
    if [ -f "$LOGFILE" ]; then
        if [ "$1" = "-f" ] || [ "$1" = "--follow" ]; then
            tail -f "$LOGFILE"
        else
            tail -n 50 "$LOGFILE"
        fi
    else
        echo "Log file not found: $LOGFILE"
        return 1
    fi
}

do_kubeconfig() {
    if [ -f "$KUBECONFIG_PATH" ]; then
        cat "$KUBECONFIG_PATH"
        return 0
    else
        echo "Kubeconfig not found at: $KUBECONFIG_PATH"
        echo "Make sure KubeSolo has been started at least once."
        return 1
    fi
}

# Main command handler
case "$1" in
    start)
        do_start
        ;;
    stop)
        do_stop
        ;;
    restart)
        do_stop
        sleep 2
        do_start
        ;;
    status)
        do_status
        ;;
    logs)
        do_logs "$2"
        ;;
    kubeconfig)
        do_kubeconfig
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status|logs|kubeconfig}"
        echo ""
        echo "Commands:"
        echo "  start       - Start KubeSolo service"
        echo "  stop        - Stop KubeSolo service"
        echo "  restart     - Restart KubeSolo service"
        echo "  status      - Check KubeSolo service status"
        echo "  logs        - Show last 50 lines of logs (use -f to follow)"
        echo "  kubeconfig  - Display kubeconfig file"
        exit 1
        ;;
esac

exit $?
