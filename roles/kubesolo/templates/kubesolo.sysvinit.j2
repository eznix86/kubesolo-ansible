#!/bin/sh
### BEGIN INIT INFO
# Provides:          kubesolo
# Required-Start:    $network $local_fs $remote_fs
# Required-Stop:     $network $local_fs $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: KubeSolo - Lightweight Kubernetes Distribution
# Description:       KubeSolo is a lightweight Kubernetes distribution
### END INIT INFO
# Generated by Ansible

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON={{ kubesolo_install_path }}
NAME=kubesolo
DESC="KubeSolo Service"
PIDFILE={{ kubesolo_pidfile }}
LOGFILE={{ kubesolo_logfile }}

# Build command arguments
CMD_ARGS="--path={{ kubesolo_path }}"
{% if kubesolo_apiserver_extra_sans | length > 0 %}
CMD_ARGS="$CMD_ARGS --apiserver-extra-sans={{ kubesolo_apiserver_extra_sans | join(',') }}"
{% endif %}
{% if kubesolo_portainer_edge_id %}
CMD_ARGS="$CMD_ARGS --portainer-edge-id={{ kubesolo_portainer_edge_id }}"
{% endif %}
{% if kubesolo_portainer_edge_key %}
CMD_ARGS="$CMD_ARGS --portainer-edge-key={{ kubesolo_portainer_edge_key }}"
{% endif %}
{% if kubesolo_portainer_edge_async %}
CMD_ARGS="$CMD_ARGS --portainer-edge-async={{ kubesolo_portainer_edge_async }}"
{% endif %}
{% if kubesolo_local_storage %}
CMD_ARGS="$CMD_ARGS --local-storage=true"
{% endif %}
{% if kubesolo_debug %}
CMD_ARGS="$CMD_ARGS --debug=true"
{% endif %}
{% if kubesolo_pprof_server %}
CMD_ARGS="$CMD_ARGS --pprof-server=true"
{% endif %}

{% if kubesolo_proxy %}
export HTTP_PROXY="{{ kubesolo_proxy }}"
export HTTPS_PROXY="{{ kubesolo_proxy }}"
export NO_PROXY="localhost,127.0.0.1,0.0.0.0,10.0.0.0/8,192.168.0.0/16"
{% endif %}

test -x $DAEMON || exit 0

. /lib/lsb/init-functions

do_start() {
    log_daemon_msg "Starting $DESC" "$NAME"
    start-stop-daemon --start --quiet --background \
        --make-pidfile --pidfile $PIDFILE \
        --startas /bin/sh -- -c "exec $DAEMON $CMD_ARGS >> $LOGFILE 2>&1"
    log_end_msg $?
}

do_stop() {
    log_daemon_msg "Stopping $DESC" "$NAME"
    start-stop-daemon --stop --quiet --retry=TERM/30/KILL/5 \
        --pidfile $PIDFILE --name $NAME
    RETVAL="$?"
    [ "$RETVAL" = 2 ] && return 2
    start-stop-daemon --stop --quiet --oknodo --retry=0/30/KILL/5 \
        --exec $DAEMON
    [ "$?" = 2 ] && return 2
    rm -f $PIDFILE
    log_end_msg 0
    return "$RETVAL"
}

do_status() {
    status_of_proc -p $PIDFILE "$DAEMON" "$NAME" && exit 0 || exit $?
}

case "$1" in
    start)
        do_start
        ;;
    stop)
        do_stop
        ;;
    status)
        do_status
        ;;
    restart|force-reload)
        do_stop
        do_start
        ;;
    *)
        echo "Usage: $0 {start|stop|status|restart|force-reload}" >&2
        exit 3
        ;;
esac

:
